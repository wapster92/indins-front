* [Компонент фильтров](#dynamicfilters)
* [Фильтры](#фильтры)
    * [Текстовый фильтр (TextFilter)](#textfilter)
    * [Числовой фильтр (NumberFilter)](#numberfilter)
    * [Фильтр по дате (DateFilter)](#datefilter)
    * [Булевый фильтр (BooleanFilter)](#booleanfilter)
    * [Фильтр связей (RelationFilter)](#relationfilter)

[Вернуться к документации листинга](/src/components/listing/README.md#dynamiclisting)
[Вернуться к содержанию](/README.md#содержание)

## DynamicFilters
Компонент фильтров, который используется внутри DynamicListing. Можно использовать отдельно, поэтому описываю его. Свойств нет.

### Слоты:
* **default** - стандартный слот компонента, в который передаются фильтры. Если ничего не передать, то в компоненте нет смысла. Принимает фильтры из ядра или ваши кастомные фильтры.

### События:
* **filter-change** (Array) - событие, которое вызывается при изменения состояния компонента. Передает массив с готовыми к использованию объектами Filter из core-xhr.


## Фильтры

## TextFilter
Фильтр по текстовой строке.

### Свойства:
* **name** (String) - поле сущности, по которому фильтрует этот фильтр. Когда фильтр кастомный, то вместо поля пишется название этого фильтра. По-умолчанию равно "".
* **active** (Boolean) - этот фильтр будет активен по умолчанию, если значение этого свойства - true. В этом случае необходимо указывать *default-value* для корректной работы. По-умолчанию равно false.
* **label** (String) - визуальное название фильтра. Отображается до значения фильтра. По-умолчанию равно "Текстовый фильтр".
* **default-value** (String) - значение, которое принимает фильтр по умолчанию, если свойство *active* равно true. По-умолчанию равно "".
* **mandatory** (Boolean) - обязан ли присутствовать этот фильтр на данной странице. Значение true убирает закрывающий крестик из блока фильтра и не дает обнулить его значение.
* **filter-type** (String) - определяет тип фильтра для core-api. По-умолчанию равен "eq".

## NumberFilter
Фильтр по числу. Не даёт вводить в качестве своего значения что-то, кроме чисел. Имеет максимальное значение и максимальное кол-во знаков до и после запятой, чтобы предотвратить integer overflow.

### Свойства:
* **name** (String) - поле сущности, по которому фильтрует этот фильтр. Когда фильтр кастомный, то вместо поля пишется название этого фильтра. По-умолчанию равно "".
* **active** (Boolean) - этот фильтр будет активен по умолчанию, если значение этого свойства - true. В этом случае необходимо указывать *default-value* для корректной работы. По-умолчанию равно false.
* **label** (String) - визуальное название фильтра. Отображается до значения фильтра. По-умолчанию равно "Число".
* **default-value** (String) - значение, которое принимает фильтр по умолчанию, если свойство *active* равно true. По-умолчанию равно "".
* **mandatory** (Boolean) - обязан ли присутствовать этот фильтр на данной странице. Значение true убирает закрывающий крестик из блока фильтра и не дает обнулить его значение.
* **filter-type** (String) - определяет тип фильтра для core-api. По-умолчанию равен "eq".

## DateFilter
Фильтр, по дате или промежутку дат.

### Свойства:
* **name** (String) - поле сущности, по которому фильтрует этот фильтр. Когда фильтр кастомный, то вместо поля пишется название этого фильтра. По-умолчанию равно "".
* **active** (Boolean) - этот фильтр будет активен по умолчанию, если значение этого свойства - true. В этом случае необходимо указывать *default-value* для корректной работы. По-умолчанию равно false.
* **label** (String) - визуальное название фильтра. Отображается до значения фильтра. По-умолчанию равно "Фильтр по дате".
* **default-value** (String, Array) - значение, которое принимает фильтр по умолчанию, если свойство *active* равно true. Принимает строку даты или массив таких строк. По-умолчанию равно "".
* **mandatory** (Boolean) - обязан ли присутствовать этот фильтр на данной странице. Значение true убирает закрывающий крестик из блока фильтра и не дает обнулить его значение.
* **filter-type** (String) - определяет тип фильтра для core-api. По-умолчанию равен "eq".
* **range** (Boolean) - когда значение этого свойства равно true, позволяет пользователю фильтра выбирать две даты вместо одной. Фильтр автоматически сформирует из них промежуток (меняя даты местами при необходимости).
* **date-format** (DateString) - меняет формат отображения даты в фильтре. Используется методом format библиотеки moment. Значение свойства по умолчанию 'DD.MM.YYYY'.
* **type** (String) - определяет тип выпадающего окна. Доступные значения - "date" и "month". По-умолчанию равно "date".

## BooleanFilter
Фильтр по булевым значениям. Рекомендуется также использовать этот компонент для exists фильтров (в этом случае нужно передать filter-type="exists").

### Свойства:
* **name** (String) - поле сущности, по которому фильтрует этот фильтр. Когда фильтр кастомный, то вместо поля пишется название этого фильтра. По-умолчанию равно "".
* **active** (Boolean) - этот фильтр будет активен по умолчанию, если значение этого свойства - true. В этом случае необходимо указывать *default-value* для корректной работы. По-умолчанию равно false.
* **label** (String) - визуальное название фильтра. Отображается до значения фильтра. По-умолчанию равно "Булевый фильтр".
* **default-value** (Boolean) - значение, которое принимает фильтр по умолчанию, если свойство *active* равно true. По-умолчанию равно "".
* **mandatory** (Boolean) - обязан ли присутствовать этот фильтр на данной странице. Значение true убирает закрывающий крестик из блока фильтра и не дает обнулить его значение.
* **filter-type** (String) - определяет тип фильтра для core-api. По-умолчанию равен "bool".
* *true-text* и **false-text** (String) - оба свойства делают одно и тоже - заменяют визуальное отображение значений true и false соответственно. Значения по умолчанию - 'Да' и 'Нет'.

## RelationFilter
Фильтр по полям вложенных сущностей. По-умолчанию фильтрует по id вложенных сущностей, но можно использовать и другие поля.

### Свойства:
* **name** (String) - поле сущности, по которому фильтрует этот фильтр. Когда фильтр кастомный, то вместо поля пишется название этого фильтра. По-умолчанию равно "".
* **active** (Boolean) - этот фильтр будет активен по умолчанию, если значение этого свойства - true. В этом случае необходимо указывать *default-value* для корректной работы. По-умолчанию равно false.
* **label** (String) - визуальное название фильтра. Отображается до значения фильтра. По-умолчанию равно "Фильтр по сущностям".
* **default-value** (Object, null) - значение, которое принимает фильтр по умолчанию, если свойство *active* равно true. По-умолчанию равно null.
* **mandatory** (Boolean) - обязан ли присутствовать этот фильтр на данной странице. Значение true убирает закрывающий крестик из блока фильтра и не дает обнулить его значение.
* **filter-type** (String) - определяет тип фильтра для core-api. По-умолчанию равен "eq".
* **item-text** (String) - поле в сущности, которое используется при генерации выпадающего списка. По-умолчанию равно "name".
* **query** (Object, String, null) - запрос для получения содержимого выпадающего списка. Принимает результат вызова new Get() или строку, которую необходимо в него передать. Использовать, когда нет необходимости генерировать список самостоятельно. По-умолчанию равно null.
> Например {'roles.keyWord' : 'ROLE_CLIENT_MANAGER'} в качестве значения может быть как примитив, так и массив.
* **filter-by** (String) - поле объектов выпыдающего списка, которое будет использоваться для фильтрации. По-умолчанию равно "id".
* **multiple-filter-type** (String) - определяет тип фильтра в случае, если multiple свойство равно true. По-умолчанию равно "ineq".
* **multiple-search-field** (String) - определяет, по какому полю сущности фильтрует строка поиска в выпадающем списке. По-умолчанию равно 'name'.
* **items** (Array) - свойство, которое используется только если вы не хотите получать выпадающий список с апи, а вместо этого генерируете его сами. По-умолчанию равно [].
* **allow-deleted** (Boolean) - свойство, которое работает только если используется свойство entity. Если включен, то выпадающий список будет формироваться из всех элементов, которые возвращает запрос. Если выключено, то запрос вернет только не удаленные сущности (deletedAt === null). По-умолчанию равно false.
* **multiple** (Boolean) - свойство, позволяющее выбирать несколько элементов выпадающего списка. По-умолчанию равно false.

  > **О создании собственных фильтров**.
  > Чтобы фильтр работал при использовании в листинге, необходимо соблюсти 6 условий:
  > 1) Фильтр обязан иметь свойство name.
  > 2) Фильтр должен использовать inject. Значения, которые необходимо импортировать (только если они используются): filtersState, registerFilter, destroyFilter, toggleFilter, changeFilter, getFilter, removeFilter.
  > 3) Должен иметь computed свойство open, описанное в точности как в примере ниже.
  > 4) На created хуке необходимо вызвать метод, registerFilter, который предоставляется компонентом DynamicFilter. В него необходимо передать имя фильтра и объект с настройками - см. пример.
  > 5) Когда необходимо изменить значение фильтра, в DynamicFilters, необходимо вызывать метод this.changeFilter. Первым аргументом он получает имя фильтра, а вторым - поля, которые необходимо поменять в состоянии (см. пример).
  > 6) На beforeDestroy хуке необходимо вызвать destroyFilter и передать туда имя фильтра.
  > 7) Фильтр должен скрывать свой корневой элемент через v-show, когда он не активен. Также, когда необходимо обнулить фильтр и не применять его, необходимо вызвать методв removeFilter и передать туда имя фильтра. См. пример.
  > 8) Для открытия/закрытия фильтра используется toggleFilter метод, в который необходимо передать имя фильтра и, по необходимости, Boolean.
  > 9) Для получения доступа к состоянию фильтра используется метод getFilter. Лучше всего сделать для этого computed свойство - см. пример.

  ```
  // Пример создания фильтра (на примере BooleanFilter).
  <template>
    <div class="filter-item" v-show="isActive">
      <v-menu
        :close-on-content-click="false"
        v-model="open"
        transition="scale-transition"
        attach=".listing-filters"
      >
        <template #:activator="{ on }">
          <v-chip
            label
            :close="!mandatory"
            close-icon="mdi-close"
            color="#F3F5F8"
            small
            v-on="on"
            @click:close="reset"
          >
            <span class="filter-label">
              {{visibleLabel}}:
            </span>
            {{visibleValue}}
          </v-chip>
        </template>
        <v-list>
          <v-list-item dense @click="changeValue(true)">{{trueText}}</v-list-item>
          <v-list-item dense @click="changeValue(false)">{{falseText}}</v-list-item>
        </v-list>
      </v-menu>
    </div>
  </template>

  <script>
    export default {
      name: "BooleanFilter",
      // Получаем методы и свойства предоставленные компонентом DynamicFilters.
      inject: {
        filtersState: {
          default: null,
        },
        registerFilter: {
          default: null,
        },
        destroyFilter: {
          default: null,
        },
        toggleFilter: {
          default: null,
        },
        changeFilter: {
          default: null,
        },
        getFilter: {
          default: null,
        },
        removeFilter: {
          default: null,
        },
      },
      props: {
        // Имя фильтра обязательно.
        name: {
          type: String,
          required: true,
        },
        // Название фильтра для пользователей.
        label: {
          type: String,
          default: 'Булевый фильтр',
        },
        // Возможность включать фильтр изначально.
        active: {
          type: Boolean,
          default: false,
        },
        // Дефолтное значение, если фильтр включен. Можно объединить в одну пропу с active.
        defaultValue: {
          type: Boolean,
          default: false,
        },
        // Что показывать при true значении в фильтре.
        trueText: {
          type: String,
          default: "Да",
        },
        // Что показывать при false значении в фильтре.
        falseText: {
          type: String,
          default: "Нет",
        },
        // Тип фильтра для core-api.
        filterType: {
          type: String,
          default: "bool",
        },
        // Обязательность фильтра.
        mandatory: {
          type: Boolean,
          default: false,
        },
      },
      data() {
        return {
          // Храним локальное значение.
          value: null,
        };
      },
      computed: {
        // Значение, которое показывается пользователю.
        visibleValue() {
          return this.value === true ? this.trueText : this.falseText;
        },
        // Обработка названия фильтра, чтобы не давать вводить слишком длинные названия.
        visibleLabel() {
          const wholeString = this.label + ': ' + this.visibleValue;
          if (wholeString.length <= 45) return this.label;
          return this.label.slice(0, 38 - this.visibleValue.length) + '...';
        },
        // Получение состояния фильтра из DynamicFilters.
        currentFilter() {
          if (!this.getFilter) return null;
          return this.getFilter(this.name);
        },
        // Открытие и закрытие фильтра. Делается в формате геттера и сеттера, чтобы
        // можно было использовать v-model с этим свойством. Для открытия фильтра
        // вызывается метод toggleFilter.
        open: {
          get() {
            return this.currentFilter && this.currentFilter.open;
          },
          set(value) {
            if (this.toggleFilter) this.toggleFilter(this.name, value);
          },
        },
        // Активность фильтра, чтобы скрывать его из списка активных фильтров.
        isActive() {
          return this.currentFilter && this.currentFilter.active;
        },
      },
      methods: {
        // Функция для удаления фильтра. Делается чере
        reset() {
          if (this.mandatory || !this.removeFilter) return;
          this.value = null;
          this.removeFilter(this.name);
        },
        // Функция для локального изменения значения.
        changeValue(val) {
          this.value = val;
          if (this.$getType(this.value) !== 'Boolean') {
            return this.reset();
          }
          this.synchroniseChanges();
          this.open = false;
        },
        // Функция для обновления состояния в DynamicFilters.
        synchroniseChanges() {
          this.changeFilter(this.name, {value: this.value});
        },
      },
      // Регистрируем состояние фильтра в DynamicFilters.
      created() {
        if (!this.registerFilter) return;
        this.registerFilter(this.name, {
          open: false,
          name: this.name,
          active: this.active,
          mandatory: this.mandatory,
          value: this.defaultValue,
          label: this.label,
          type: this.filterType,
        });
        this.value = this.defaultValue;
      },
      // Убираем состояние фильтра при уничтожении компонента, чтобы фильтры
      // слот DynamicFilters реагировал на изменения в слоте.
      beforeDestroy() {
        if (!this.currentFilter || !this.destroyFilter) return;
        this.destroyFilter(this.name);
      },
    }
  </script>
  ```